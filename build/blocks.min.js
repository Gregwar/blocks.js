function arrayRemove(a,b){b=parseInt(b);var c=a[a.length-1];a[a.length-1]=a[b],a[b]=c,a.pop()}function ConnectorImport(a){if(!(a instanceof Array)||a.length<2||a.length>3)throw"Unable to import a connector";return a.length==2&&a.push(null),new Connector(a[0],a[1],a[2])}function IdToConnector(a){var b=a.split("_"),c=b[0],d=b[1],e=null;return b.length==3&&(e=b[2]),new Connector(c,d,e)}function EdgeImport(a,b){if(!1 in b)throw"An edge does not have id";var c=a.getBlockById(b.block1),d=a.getBlockById(b.block2);if(!c||!d)throw"Error while importing an edge, a block did not exists";return new Edge(b.id,c,ConnectorImport(b.connector1),d,ConnectorImport(b.connector2),a)}function BlockImport(a,b){for(var c in a.metas){var d=a.metas[c],e="module"in b?b.module:null;if(d.name==b.type&&d.module==e){var f=new Block(a,d,b.id);return f.x=b.x,f.y=b.y,f.setValues(b.values),f}}throw"Unable to create a block of type "+b.type}"use strict","use strict";var Field=function(a){var b=this;this.onUpdate=null,this.value=null,"defaultValue"in a&&(this.value=a.defaultValue),a.unit==undefined?this.unit="":this.unit=a.unit,this.dimension="dimension"in a?a.dimension:null,this.attrs=a.attrs,this.asTitle="asTitle"in a&&a.asTitle;if(a.type==undefined)this.type="string";else{var c=a.type.toLowerCase();c=Types.normalize(c),this.type=c}this.card="card"in a?a.card:"*",this.card=this.parseCardinality(this.card,this.is("output")),this.hide="hide"in a&&a.hide,this.hideLabel="hideLabel"in a&&a.hideLabel,this.name=a.name.toLowerCase(),this.label="label"in a?a.label:a.name,this.dynamicLabel="dynamicLabel"in a?a.dynamicLabel:null,this.choices="choices"in a?a.choices:null,this.extensible="extensible"in a&&a.extensible,this.size=1,this.isArray=this.type.substr(-2)=="[]",this.isArray&&(this.dimension==null&&(this.dimension=this.name),this.type=this.type.substr(0,this.type.length-2)),this.variadic=!!this.dimension,this.defaultValue="defaultValue"in a?a.defaultValue:null};Field.prototype.updated=function(){this.onUpdate&&this.onUpdate()},Field.prototype.getFieldHtml=function(){var a=this.label+":<br/>";if(this.isArray){a+='<div class="fieldsArray">',a+='<div class="pattern">',a+=this.getSingleFieldHtml(""),a+="</div>",a+='<div class="fields">';var b=this.getValue();for(var c in b)a+='<div class="field">',a+=this.getSingleFieldHtml(b[c]),a+="</div>";a+="</div>",a+="</div>"}else a+=this.getSingleFieldHtml();return a+="<br/>",a},Field.prototype.getFieldName=function(){var a=this.name;return this.isArray&&(a+="[]"),a},Field.prototype.getSingleFieldHtml=function(a){var b="";a==undefined&&(a=this.getPrintableValue());if(this.type=="longtext")b+='<textarea name="'+this.getFieldName()+'"></textarea>';else if(this.type=="choice"||this.choices){b+='<select name="'+this.getFieldName()+'">';for(var c in this.choices){var d=this.choices[c],e=d==a?"selected":"";b+="<option "+e+' value="'+d+'">'+d+"</option>"}b+="</select>"}else{var f=this.type=="bool"?"checkbox":"text";b+='<input value="'+a+'" type="'+f+'" name="'+this.getFieldName()+'" />'+this.unit}return b},Field.prototype.getHtml=function(){var a="";return this.hideLabel||(a+="<b>"+this.label+"</b>: "),a+=this.getPrintableValueWithUnit()+"<br/>",a},Field.prototype.getValue=function(){return this.value},Field.prototype.getPrintableValue=function(a){var b=this.getValue();return b instanceof Array&&(a==undefined?b=b.join(", "):b=b[a]),b},Field.prototype.getPrintableValueWithUnit=function(a){var b=this.getPrintableValue(a);return this.unit&&(b+=this.unit),b},Field.prototype.getLabel=function(){return this.label},Field.prototype.setValue=function(a){this.isArray&&!(a instanceof Array)&&(a=a.split(", ")),this.type=="bool"&&(a=!!a),this.value=a},Field.prototype.asDimension=function(){if(this.extensible)return this.size+1;if(this.isArray){var a=this.getValue();if(a instanceof Array)return this.getValue().length;throw"Unable to get the dimension of field "+this.name}return parseInt(this.getValue())},Field.prototype.getDimension=function(a){if(typeof this.dimension=="number")return this.dimension;var b=a.getField(this.dimension);if(!b)throw"Unable to find dimension field "+this.dimension;return b.asDimension()},Field.prototype.is=function(a){return a in this.attrs},Field.prototype.parseCardinality=function(a,b){var c=[0,1];b&&(c=[0,"*"]);if(a!=undefined)if(typeof a!="string")c=[a,a];else{var d=a.split("-");d.length==1?c=[0,d[0]]:c=d}for(var e in c)c[e]!="*"&&(c[e]=parseInt(c[e]));return c},"use strict";var Fields=function(a){var b=this;this.block=a,this.meta=this.block.meta,this.display=!1,this.div=null,this.fields=[];for(var c in this.meta.fields){var d=new Field(this.meta.fields[c]);d.onUpdate=function(){b.block.cssParameters()},this.fields.push(d)}this.inputs=[],this.outputs=[],this.editables=[],this.indexedFields={};for(var c in this.fields){var d=this.fields[c];this.indexedFields[d.name]=d,"editable"in d.attrs&&this.editables.push(d),"input"in d.attrs&&(this.inputs.push(d),d.hide=!0),"output"in d.attrs&&(this.outputs.push(d),d.hide=!0)}};Fields.prototype.getField=function(a){return a=a.toLowerCase(),a in this.indexedFields?this.indexedFields[a]:null},Fields.prototype.show=function(){var a=this,b="<h3>"+this.block.meta.name+"#"+this.block.id+"</h3>";b+='<form class="form">';for(var c in this.editables)b+=this.editables[c].getFieldHtml();b+='<input type="submit" style="display:none" width="0" height="0" />',b+="</form>",b+='<button class="save" href="javascript:void(0);">Save</button>',b+='<button class="close" href="javascript:void(0);">Close</button>',this.div.html(b),this.div.find(".close").click(function(){$.fancybox.close()});var d=this.div.find("form");this.div.find(".save").click(function(){d.find(".pattern").remove(),a.save(d.serializeForm()),$.fancybox.close()}),this.div.find("form").submit(function(){return d.find(".pattern").remove(),a.save($(this).serializeForm()),$.fancybox.close(),!1}),this.div.find("input").dblclick(function(){$(this).select()}),this.handleArrays(),$.fancybox.open(this.div,{wrapCSS:"blocks_js_modal"}),this.display=!0},Fields.prototype.handleArrays=function(){this.div.find(".fieldsArray").each(function(){var a=$(this).find(".pattern").html(),b=$(this).find(".fields"),c='<div class="buttons">';c+='<a class="add" href="#">Add</a> ',c+='<a class="remove" href="#">Remove</a>',c+="</div>",$(this).append(c),$(this).find(".add").click(function(){b.append('<div class="field">'+a+"</div>")}),$(this).find(".remove").click(function(){b.find(".field").last().remove()})})},Fields.prototype.getHtml=function(){var a="";for(var b in this.editables)a+=this.editables[b].getHtml();return a},Fields.prototype.hide=function(){this.div.hide(),this.display=!1},Fields.prototype.save=function(a){var b={};for(var c in a){var d=c,e=!1;d.substr(d.length-2,2)=="[]"&&(d=d.substr(0,d.length-2),e=!0),a[c]==null&&e&&(a[c]=[]),this.getField(d).setValue(a[c])}this.block.render(),this.block.redraw()},Fields.prototype.toggle=function(){this.meta.parametersEditor!=undefined&&typeof this.meta.parametersEditor=="function"?this.meta.parametersEditor(this.block.values,function(a){this.block.updateValues(a),this.block.render(),this.block.redraw()}):this.display?this.hide():this.show()},"use strict";var Segment=function(a,b,c,d){this.x=a,this.y=b,this.dx=c,this.dy=d};Segment.prototype.distance=function(a,b){return Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))},Segment.prototype.distanceP=function(a){var b=this.normal();b.x=a.x,b.y=a.y;var c=this.intersection(b);return[c[0],this.distance(b.alpha(c[1]),a)]},Segment.prototype.normal=function(){return new Segment(this.x,this.y,this.dy,-this.dx)},Segment.prototype.intersection=function(a){var b=this.dx,c=-a.dx,d=this.dy,e=-a.dy,f=a.x-this.x,g=a.y-this.y,h=b*e-c*d;if(h==0)return null;var i=(e*f-c*g)/h,j=(-d*f+b*g)/h;return[i,j]},Segment.prototype.alpha=function(a){var b={};return b.x=this.x+this.dx*a,b.y=this.y+this.dy*a,b},"use strict";var Types=function(){this.compatibles={}};Types.normalize=function(a){a=a.toLowerCase();if(a=="check"||a=="bool"||a=="checkbox")a="bool";a=="integer"&&(a="int");if(a=="float"||a=="double")a="number";a=="text"&&(a="string");if(a=="select"||a=="choices"||a=="combobox")a="choice";return a=="textarea"&&(a="longtext"),a},Types.prototype.isCompatible=function(a,b){a=Types.normalize(a),b=Types.normalize(b);if(a==b)return!0;if(a in this.compatibles)for(var c in this.compatibles[a])if(b==this.compatibles[a][c])return!0;return!1},Types.prototype.getCompatibles=function(a){a=Types.normalize(a);var b=[a];if(a in this.compatibles)for(var c in this.compatibles[a])b.push(this.compatibles[a][c]);return b},Types.prototype.addCompatibilityOneWay=function(a,b){a=Types.normalize(a),b=Types.normalize(b),a in this.compatibles||(this.compatibles[a]=[]),this.compatibles[a].push(b)},Types.prototype.addCompatibility=function(a,b){a=Types.normalize(a),b=Types.normalize(b),this.addCompatibilityOneWay(a,b),this.addCompatibilityOneWay(b,a)},"use strict";var Connector=function(a,b,c){this.name=a,this.type=b,this.index=c==null?null:parseInt(c)};Connector.prototype.id=function(){var a=this.name+"_"+this.type;return this.index!=null&&(a+="_"+this.index),a},Connector.prototype.isInput=function(){return this.type=="input"},Connector.prototype.isOutput=function(){return this.type=="output"},Connector.prototype.same=function(a){return this.name==a.name&&this.index==a.index&&this.type==a.type},Connector.prototype.exportData=function(){var a=[this.name,this.type];return this.index!==null&&a.push(this.index),a},"use strict";var Edge=function(a,b,c,d,e,f){this.blocks=f,this.label=null,this.id=parseInt(a),this.block1=b,this.connector1=c,this.block2=d,this.connector2=e,this.selected=!1,this.defaultSize=3,this.defaultFontSize=10,this.position1=null,this.position2=null,this.segment=null;if(!b.hasConnector(c)||!d.hasConnector(e))throw"Can't create edge because a connector don't exist"};Edge.prototype.isLoopable=function(){return this.block1.isLoopable()||this.block2.isLoopable()},Edge.prototype.fromTo=function(){return[this.block1,this.block2]},Edge.prototype.setLabel=function(a){this.label=a},Edge.prototype.draw=function(a){this.position1=this.block1.linkPositionFor(this.connector1),this.position2=this.block2.linkPositionFor(this.connector2),this.segment=new Segment(this.position1.x,this.position1.y,this.position2.x-this.position1.x,this.position2.y-this.position1.y);var b=this.defaultSize*this.blocks.scale;if(this.selected)var c="rgba(0, 200, 0, 1)";else var c="rgba(255, 200, 0, 1)";a.line(this.position1.x,this.position1.y,this.position2.x,this.position2.y,{stroke:c,strokeWidth:b});var d=(this.position1.x+this.position2.x)/2,e=(this.position1.y+this.position2.y)/2,f=Math.sqrt(Math.pow(this.position1.x-this.position2.x,2)+Math.pow(this.position1.y-this.position2.y,2)),g=30;g=g*Math.PI/180;var h=Math.cos(g),i=Math.sin(g),j=Math.cos(-g),k=Math.sin(-g);if(this.blocks.getOption("orientation",!0)){var l=(this.position1.x-d)*this.blocks.scale*10/(f/2),m=(this.position1.y-e)*this.blocks.scale*10/(f/2),b=this.defaultSize*this.blocks.scale/3;a.line(d,e,d+(l*h-m*i),e+(m*h+l*i),{stroke:c,strokeWidth:b}),a.line(d,e,d+(l*j-m*k),e+(m*j+l*k),{stroke:c,strokeWidth:b})}if(this.label!=null){var n=Math.round(this.defaultFontSize*this.blocks.scale);a.text(d-2*n,e+n/3,this.label,{fontSize:n+"px",fill:"#3a3b01",stroke:"#fff",strokeWidth:2}),a.text(d-2*n,e+n/3,this.label,{fontSize:n+"px",fill:"#3a3b01"})}},Edge.prototype.collide=function(a,b){var c=this.segment.distanceP({x:a,y:b});return c[0]>=0&&c[0]<=1&&c[1]<this.defaultSize*blocks.scale*2?c[0]:!1},Edge.prototype.create=function(){if(this.block1==this.block2)throw"You can't link a block to itself";if(!this.blocks.getOption("canLinkInputs",!1)&&this.connector1.type==this.connector2.type)throw"You have to link an input with an output";if(!this.block1.canLink(this.connector1)||!this.block2.canLink(this.connector2))throw"Can't create such an edge because of the cardinalities";this.block1.addEdge(this.connector1,this),this.block2.addEdge(this.connector2,this),this.block1.render(),this.block2.render()},Edge.prototype.getTypes=function(){return[this.block1.getField(this.connector1.name).type,this.block2.getField(this.connector2.name).type]},Edge.prototype.erase=function(){this.block1.eraseEdge(this.connector1,this),this.block2.eraseEdge(this.connector2,this),this.block1.render(),this.block2.render()},Edge.prototype.same=function(a){return this.block1==a.block1&&this.block2==a.block2&&this.connector1.same(a.connector1)&&this.connector2.same(a.connector2)?!0:this.block1==a.block1&&this.block2==a.block2&&this.connector1.same(a.connector2)&&this.connector2.same(a.connector1)?!0:!1},Edge.prototype.exportData=function(){return{id:this.id,block1:this.block1.id,connector1:this.connector1.exportData(),block2:this.block2.id,connector2:this.connector2.exportData()}},"use strict";var BlocksMessages=function(a,b){var c=this;this.hideTimer=null,this.messages=a,this.width=b,a.click(function(){c.hide()})};BlocksMessages.prototype.show=function(a,b){var c=this;this.hideTimer!=null&&clearTimeout(this.hideTimer);var d="message";b["class"]!=undefined&&(d+=" "+b["class"]);var e='<div class="'+d+'">'+a+"</div>";this.messages.html(e),this.messages.fadeIn(),this.messages.css("margin-left",Math.round((this.width-350)/2)+"px"),this.messages.css("margin-top","20px"),this.hideTimer=setTimeout(function(){c.hide()},5e3)},BlocksMessages.prototype.hide=function(){this.messages.fadeOut(),this.hideTimer=null},"use strict";var BlocksMenu=function(a){var b=this;this.visible=!1,this.position={},this.blocks=a,this.menu=a.div.find(".contextmenu"),this.actions=[{label:"Compact",action:function(a){a.toggleCompact()},icon:"compact"},{label:"Scale",action:function(a){a.perfectScale()},icon:"scale"}],a.div.bind("contextmenu",function(){if(b.visible)b.hide();else{b.position=a.getPosition();var c={};for(var d in a.metas){var e=a.metas[d];e.family in c?c[e.family].push(e):c[e.family]=[e]}var f="";for(var g in b.actions){var h="none";"icon"in b.actions[g]&&(h=b.actions[g].icon),f+='<div rel="'+g+'" class="menuentry menu_action_'+g+'"><div class="menu_icon menu_icon_'+h+'"></div>'+b.actions[g].label+"</div>"}for(var i in c){if(i){var j=i.replace(/[^a-zA-Z]/g,"");f+='<div class="family">',f+='<div class="familyName family_'+i+'"><div class="menu_icon menu_icon_family_'+j+'"></div>'+i+" <span>&raquo;</span></div>",f+='<div class="childs">'}for(var d in c[i]){var k=c[i][d];f+='<div class="type type_'+k.name+'" rel="'+k.name+'">'+k.name+"</div>"}i&&(f+="</div>",f+="</div>")}b.menu.find(".types").html(f),b.show(),b.menu.find(".type").click(function(){a.addBlock($(this).attr("rel"),b.position.x,b.position.y),b.hide()}),b.menu.find(".family").each(function(){var a=$(this);$(this).find(".familyName").hover(function(){b.menu.find(".childs").hide(),a.find(".childs").show()})});for(var d in b.actions)b.menu.find(".menu_action_"+d).click(function(){var c=b.actions[$(this).attr("rel")];c.action(a),b.hide()});$(this).find(".types > .type").hover(function(){b.menu.find(".childs").hide()})}return!1})};BlocksMenu.prototype.addAction=function(a,b,c){this.actions.push({label:a,action:b,icon:c})},BlocksMenu.prototype.hide=function(){this.menu.hide(),this.visible=!1},BlocksMenu.prototype.show=function(){this.menu.css("margin-left",5+this.blocks.mouseX+"px"),this.menu.css("margin-top",5+this.blocks.mouseY+"px"),this.menu.show(),this.visible=!0},"use strict";var Meta=function(a){var b=this;this.name=a.name,this.loopable="loopable"in a&&a.loopable,this.size="size"in a?a.size:"normal",this.fields=[];if("fields"in a)for(var c in a.fields){var d=a.fields[c],e="attrs"in d?d.attrs.split(" "):[];d.attrs={};for(var f in e)d.attrs[e[f]]=!0;this.fields.push(d)}for(var c in a.parametersEditor){var g=keys[c];a[g]!=undefined?this[g]=a[g]:this[g]=[]}"module"in a?this.module=a.module:this.module=null,a.family==undefined?this.family="":this.family=a.family,a["class"]!=undefined?this["class"]=a["class"]:this["class"]="",this.description=null,a.description!=undefined&&(this.description=a.description)};"use strict";var History=function(a){var b=this;this.historySize=30,this.blocks=a,this.history=[],this.historyPos=0,this.ctrlDown=!1,$(document).keydown(function(a){a.keyCode==17&&(b.ctrlDown=!0),a.keyCode==90&&b.ctrlDown&&b.restoreLast()}),$(document).keyup(function(a){a.keyCode==17&&(b.ctrlDown=!1)})};History.prototype.save=function(){this.history.push(this.blocks.exportData()),this.history.length>this.historySize&&this.history.shift()},History.prototype.restoreLast=function(){if(this.history.length){var a=this.history.pop();this.blocks.importData(a)}else alert("Nothing to get")},"use strict";var Block=function(a,b,c){this.blocks=a,this.meta=b,this.defaultFont=10,this.description=null,this.meta.size=="normal"?this.width=150:this.meta.size=="small"?this.width=100:this.width=this.meta.size,this.historySaved=!1,this.id=c,this.hasFocus=!1,this.div=null,this.drag=null,this.lastScale=null,this.fields=new Fields(this),this.x=0,this.y=0,this.ios={},this.focusedConnector=null,this.edges={},this.connectors=[]};Block.prototype.isLoopable=function(){return this.meta.loopable},Block.prototype.setDescription=function(a){this.description=a,this.div.find(".description").html(a)},Block.prototype.updateValues=function(){this.blocks.history.save()},Block.prototype.setValues=function(a){for(var b in a)this.fields.getField(b).setValue(a[b])},Block.prototype.getValues=function(a){var a={};for(var b in this.fields.editables){var c=this.fields.editables[b];a[c.name]=c.getValue()}return a},Block.prototype.getValue=function(a){var b=this.fields.getField(a);return b?b.getValue():null},Block.prototype.htmlentities=function(a){return a=a.replace(/</,"&lt;"),a=a.replace(/>/,"&gt;"),a},Block.prototype.setInfos=function(a){this.div.find(".infos").html(a)},Block.prototype.getHtml=function(){var a=this;this.connectors=[];var b=this.meta.name+'<span class="blockId">#'+this.id+"</span>";for(var c in this.fields.fields){var d=this.fields.fields[c];d.asTitle&&(b=d.getPrintableValue())}var e='<div class="parameters"></div>';e+='<div class="blockTitle"><span class="titleText">'+b+'</span><div class="blockicon delete"></div>',e+='<div class="blockicon info"></div>',this.description?e+='<div class="description">'+a.description+"</div>":this.meta.description?e+='<div class="description">'+this.meta.description+"</div>":e+='<div class="description">No description</div>',e+='<div class="blockicon settings"></div></div>',e+='<div class="infos"></div>';for(var c in a.fields.editables){var d=a.fields.editables[c],f=d.getHtml();e&&!d.hide&&!d.asTitle&&!this.blocks.compactMode&&(e+='<div class="parameter">'+f+"</div>")}var g=function(b,c){e+='<div class="'+b+"s "+(a.isLoopable()?"loopable":"")+'">';for(var d in c){var f=c[d];f.extensible&&(f.size=a.maxEntry(f.name));var g=1;f.variadic&&(g=f.getDimension(a.fields));for(var h=0;h<g;h++){var i=f.name.toLowerCase()+"_"+b,j=f.getLabel().replace("#",h+1),k="";f.dynamicLabel!=null?j=String(f.dynamicLabel(a,h)):f&&f.is("editable")&&(k=" ("+f.getPrintableValueWithUnit(f.variadic?h:undefined)+")"),f.variadic&&(i+="_"+h),e+='<div class="'+b+" type_"+f.type+" connector "+i+'" rel="'+i+'"><div class="circle"></div>'+a.htmlentities(j)+k+"</div>",a.connectors.push(i)}}e+="</div>"};return g("input",this.fields.inputs),g("output",this.fields.outputs),e},Block.prototype.render=function(){this.lastScale=null,this.hasFocus=!1,this.div.html(this.getHtml()),this.initListeners(),this.redraw()},Block.prototype.maxEntry=function(a){var b=0;for(var c in this.edges)if(this.edges[c].length){var d=IdToConnector(c);d.name==a&&(b=Math.max(parseInt(d.index)+1,b))}return b},Block.prototype.create=function(a){var b='<div id="block'+this.id+'" class="block '+this.meta["class"]+'"></div>';a.append(b),this.div=a.find("#block"+this.id),this.render()},Block.prototype.redraw=function(a){this.div.css("margin-left",this.blocks.center.x+this.x*this.blocks.scale+"px"),this.div.css("margin-top",this.blocks.center.y+this.y*this.blocks.scale+"px"),this.blocks.showIcons&&this.blocks.scale>.8?this.div.find(".blockicon").show():this.div.find(".blockicon").hide();if(this.lastScale!=this.blocks.scale){this.div.css("font-size",Math.round(this.blocks.scale*this.defaultFont)+"px"),this.div.css("width",Math.round(this.blocks.scale*this.width)+"px");var b=Math.round(12*this.blocks.scale);this.div.find(".circle").css("width",b+"px"),this.div.find(".circle").css("height",b+"px"),this.div.find(".circle").css("background-size",b+"px "+b+"px"),this.div.find(".inputs, .outputs").width(this.div.width()/2-10),this.cssParameters(),this.lastScale=this.blocks.scale}for(var c in this.connectors){var d=this.connectors[c],e=this.div.find("."+d),f=e.find(".circle");f.removeClass("io_active"),f.removeClass("io_selected");if(d in this.edges&&this.edges[d].length){f.addClass("io_active");for(var g in this.edges[d])this.edges[d][g].selected&&f.addClass("io_selected")}}this.fields.div=this.div.find(".parameters"),this.div.removeClass("block_selected"),a&&this.div.addClass("block_selected")},Block.prototype.cssParameters=function(){this.div.find("input").css("font-size",Math.round(this.blocks.scale*this.defaultFont)+"px")},Block.prototype.initListeners=function(){var a=this;a.div.find(".blockTitle").mousedown(function(b){b.which==1&&(a.historySaved=!1,a.drag=[a.blocks.mouseX/a.blocks.scale-a.x,a.blocks.mouseY/a.blocks.scale-a.y])}),a.div.hover(function(){a.hasFocus=!0},function(){a.hasFocus=!1}),a.div.find(".connector").hover(function(){a.focusedConnector=$(this).attr("rel")},function(){a.focusedConnector=null}),$("html").mousemove(function(b){a.drag&&(a.historySaved||(a.blocks.history.save(),a.historySaved=!0),a.x=a.blocks.mouseX/a.blocks.scale-a.drag[0],a.y=a.blocks.mouseY/a.blocks.scale-a.drag[1],a.blocks.redraw())}),$("html").mouseup(function(){a.drag=null}),a.div.find(".connector").mousedown(function(b){b.which==1&&(a.blocks.beginLink(a,$(this).attr("rel")),b.preventDefault())}),a.div.find(".settings").click(function(){a.fields.toggle(),a.cssParameters()}),a.div.find(".delete").click(function(){a.blocks.removeBlock(a.blocks.getBlockId(a))}),a.div.find(".info").hover(function(){a.div.find(".description").show()},function(){a.div.find(".description").hide()})},Block.prototype.linkPositionFor=function(a){var b=a;a instanceof Object&&(b=a.id());try{var c=this.div.find("."+b+" .circle"),d=c.offset().left-this.blocks.div.offset().left+c.width()/2,e=c.offset().top-this.blocks.div.offset().top+c.height()/2}catch(f){throw"Unable to find link position for "+b+" ("+f+")"}return{x:d,y:e}},Block.prototype.canLink=function(a){var b=[],c=a.id();c in this.edges&&(b=this.edges[c]);var d=this.fields.getField(a.name).card;return d[1]=="*"?!0:b.length<d[1]},Block.prototype.addEdge=function(a,b){var c=[],d=a.id();this.edges[d]!=undefined&&(c=this.edges[d]),c.push(b),this.edges[d]=c},Block.prototype.eraseEdge=function(a,b){var c=a.id();if(this.edges[c]!=undefined)for(var d in this.edges[c])if(this.edges[c][d]==b){arrayRemove(this.edges[c],d);break}},Block.prototype.erase=function(){this.div.remove()},Block.prototype.allSuccessors=function(){var a={},b=[this],c=[this.id];a[this.id]=!0;while(b.length>0){var d=b.pop();for(var e in d.edges)for(var f in d.edges[e]){var g=d.edges[e][f];if(g.isLoopable())continue;var h=g.fromTo();if(h[0]==d){var i=h[1];i.id in a||(a[i.id]=!0,b.push(i),c.push(i.id))}}}return c},Block.prototype.exportData=function(){return{id:this.id,x:this.x,y:this.y,type:this.meta.name,module:this.meta.module,values:this.getValues()}},Block.prototype.getField=function(a){return this.fields.getField(a)},Block.prototype.hasConnector=function(a){var b=this.getField(a.name);return b?b.variadic?a.index!=null&&b.getDimension(this.fields)>=a.index:a.index==null:!1},"use strict";var Blocks=function(a){typeof a!="undefined"?this.options=a:this.options={},this.types=new Types,this.center={},this.scale=1,this.redrawTimeout=null,this.history=null,this.moving=null,this.isReady=!1,this.compactMode=!1,this.menu=null,this.mouseX=0,this.mouseY=0,this.linking=null,this.selectedLink=null,this.selectedSide=null,this.selectedBlock=null,this.div=null,this.context=null,this.metas=[],this.blocks=[],this.edges=[],this.id=1,this.edgeId=1,this.clear=function(){this.edges=[],this.blocks=[],this.id=1,this.edgeId=1,this.div.find(".blocks").html(""),this.redraw()},this.getOption=function(a,b){return a in this.options?this.options[a]:b},this.showIcons=!0};Blocks.prototype.run=function(a){var b=this;$(document).ready(function(){b.div=$(a),b.div.size()||alert("blocks.js: Unable to find "+a),b.div.html('<div class="blocks_js_editor"><div class="messages"></div><div class="contextmenu"><div class="types"></div></div><svg xmlns="http://www.w3.org/2000/svg" version="1.1"></svg><div class="blocks"></div></div>'),b.div.find("svg").css("width","100%"),b.div.find("svg").css("height","100%"),b.context=b.div.find("svg"),b.center.x=b.div.width()/2,b.center.y=b.div.height()/2,b.menu=new BlocksMenu(b),b.messages=new BlocksMessages(b.div.find(".messages"),b.div.width()),b.div[0].addEventListener("mousemove",function(a){b.mouseX=a.pageX-b.div.offset().left,b.mouseY=a.pageY-b.div.offset().top,b.move(a)}),$("html").mouseup(function(a){a.which==1&&b.release()}),b.div.mousedown(function(a){b.canvasClicked()&&a.preventDefault();if(a.which==2||!b.selectedLink&&!b.selectedBlock&&a.which==1)b.moving=[b.mouseX,b.mouseY]}),b.div.mouseup(function(a){if(a.which==2||a.which==1)b.moving=null;a.which==1&&b.menu.hide()}),b.context.svg(),$(document).keydown(function(a){if($("input").is(":focus"))return;a.keyCode==46&&b.deleteEvent()}),b.div.bind("mousewheel",function(a,c,d,e){var f=b.mouseX-b.center.x,g=b.mouseY-b.center.y,h=Math.pow(1.1,e);b.center.x-=f*(h-1),b.center.y-=g*(h-1),b.scale*=h,b.redraw(),a.preventDefault()}),b.history=new History(b),b.isReady||b.postReady()})},Blocks.prototype.postReady=function(){this.isReady=!0;if(this.readyQueue!=undefined)for(var a in this.readyQueue)this.readyQueue[a]()},Blocks.prototype.ready=function(a){if(this.isReady)a();else{var b=[];this.readyQueue!=undefined&&(b=this.readyQueue),b.push(a),this.readyQueue=b}},Blocks.prototype.getPosition=function(){var a={};return a.x=(this.mouseX-this.center.x)/this.scale,a.y=(this.mouseY-this.center.y)/this.scale,a},Blocks.prototype.addBlock=function(a,b,c){for(var d in this.metas){var e=this.metas[d];if(e.name==a){var f=new Block(this,this.metas[d],this.id);f.x=b,f.y=c,f.create(this.div.find(".blocks")),this.history.save(),this.blocks.push(f),this.id++}}},Blocks.prototype.register=function(a){this.metas.push(new Meta(a))},Blocks.prototype.beginLink=function(a,b){this.linking=[a,b],this.highlightTargets()},Blocks.prototype.highlightTargets=function(){var a=this.linking[0],b=IdToConnector(this.linking[1]),c=a.getField(b.name).type;$(".connector").addClass("disabled");var d=this.types.getCompatibles(c);for(var e in d){var f=d[e];$(".connector.type_"+f).removeClass("disabled")}},Blocks.prototype.move=function(){if(this.selectedSide){var a=Math.sqrt(Math.pow(this.mouseX-this.selectedSide[1],2)+Math.pow(this.mouseY-this.selectedSide[2],2));if(a>15){var b=this.edges[this.selectedLink];this.selectedSide[0]==2?this.linking=[b.block1,b.connector1.id()]:this.linking=[b.block2,b.connector2.id()],this.removeEdge(this.selectedLink),this.selectedSide=null,this.highlightTargets(),this.selectedLink!=null&&(this.edges[this.selectedLink].selected=!1),this.selectedLink=null,this.redraw()}}this.moving&&(this.center.x+=this.mouseX-this.moving[0],this.center.y+=this.mouseY-this.moving[1],this.moving=[this.mouseX,this.mouseY],this.redraw()),this.linking&&this.redraw()},Blocks.prototype.canvasClicked=function(){var a=!1;this.selectedBlock=null,this.selectedLink!=null&&(this.edges[this.selectedLink].selected=!1),this.selectedLink=null,this.selectedSide=null;for(var b in this.blocks){var c=this.blocks[b];c.hasFocus&&(this.selectedBlock=b)}if(!this.selectedBlock)for(var b in this.edges){var d=this.edges[b].collide(this.mouseX,this.mouseY);if(d!=0){d<.2?this.selectedSide=[1,this.mouseX,this.mouseY]:d>.8&&(this.selectedSide=[2,this.mouseX,this.mouseY]),this.selectedLink=b,this.edges[b].selected=!0,a=!0;break}}return this.redraw(),a},Blocks.prototype.removeEdge=function(a){this.history.save(),this.edges[a].erase(),arrayRemove(this.edges,a)},Blocks.prototype.getEdgeId=function(a){for(var b in this.edges)if(a==this.edges[b])return b;return!1},Blocks.prototype.removeBlock=function(a){var b=this.blocks[a],c=[];for(var d in this.edges){var e=this.edges[d];e.block1==b||e.block2==b?e.erase():c.push(e)}this.edges=c,b.erase(),arrayRemove(this.blocks,this.selectedBlock),this.redraw()},Blocks.prototype.getBlockId=function(a){for(var b in this.blocks)if(this.blocks[b]==a)return b;return null},Blocks.prototype.getBlockById=function(a){for(var b in this.blocks)if(this.blocks[b].id==a)return this.blocks[b];return null},Blocks.prototype.deleteEvent=function(){this.selectedBlock!=null&&(this.history.save(),this.removeBlock(this.selectedBlock),this.selectedBlock=null),this.selectedLink!=null&&(this.history.save(),this.removeEdge(this.selectedLink),this.selectedLink=null,this.redraw())},Blocks.prototype.doRedraw=function(){for(var a in this.blocks)this.blocks[a].redraw(this.selectedBlock==a);var b=this.context.svg("get");b.clear();for(var a in this.edges)this.edges[a].draw(b);if(this.linking)try{var c=this.linking[0].linkPositionFor(this.linking[1]);b.line(c.x,c.y,this.mouseX,this.mouseY,{stroke:"rgba(0,0,0,0.4)",strokeWidth:3*this.scale})}catch(d){this.linking=null}this.redrawTimeout=null},Blocks.prototype.redraw=function(){var a=this;this.redrawTimeout||(this.redrawTimeout=setTimeout(function(){a.doRedraw()},25))},Blocks.prototype.release=function(){this.linking&&(this.tryEndLink(),this.linking=null),$(".connector").removeClass("disabled"),this.redraw()},Blocks.prototype.tryEndLink=function(){for(var a in this.blocks){var b=this.blocks[a];if(b.hasFocus&&b.focusedConnector){this.endLink(b,b.focusedConnector);break}}},Blocks.prototype.endLink=function(a,b){try{var c=this.edgeId++,d=this.linking[0],e=IdToConnector(this.linking[1]),f=a,g=IdToConnector(b);if(e.isOutput())var h=new Edge(c,d,e,f,g,this);else var h=new Edge(c,f,g,d,e,this);for(var i in this.edges){var j=this.edges[i];if(j.same(h))throw"This edge already exists"}var k=h.fromTo();if(k[1].allSuccessors().indexOf(k[0].id)!=-1)throw"You can not create a loop";this.history.save(),h.create();var l=this.edges.push(h)-1,m=h.getTypes();if(!this.types.isCompatible(m[0],m[1]))throw this.removeEdge(l),"Types "+m[0]+" and "+m[1]+" are not compatible"}catch(n){this.messages.show("Unable to create this edge :\n"+n,{"class":"error"})}this.linking=null,this.selectedBlock=null,this.redraw()},Blocks.prototype.toggleCompact=function(){this.compactMode=!this.compactMode;for(var a in this.blocks)this.blocks[a].render();this.redraw()},Blocks.prototype.exportData=function(){var a=[],b=[];for(var c in this.blocks)a.push(this.blocks[c].exportData());for(var c in this.edges)b.push(this.edges[c].exportData());return{edges:b,blocks:a}},Blocks.prototype.importData=function(a){this.clear(),this.doLoad(a,!1)},Blocks.prototype.load=function(a){this.doLoad(a,!0)},Blocks.prototype.doLoad=function(a,b){var c=this;this.ready(function(){var d=[];c.id=1,c.edgeId=1;for(var e in a.blocks)try{var f=a.blocks[e],g=BlockImport(c,f);c.id=Math.max(c.id,g.id+1),g.create(c.div.find(".blocks")),c.blocks.push(g)}catch(h){d.push("Block #"+e+":"+h)}for(var e in a.edges)try{var f=a.edges[e],i=EdgeImport(c,f);c.edgeId=Math.max(c.edgeId,i.id+1),i.create(),c.edges.push(i)}catch(h){d.push("Edge #"+e+" :"+h)}if(d.length){var j=d.length+" loading errors :<br/>";j+="<ul>";for(var e in d)j+="<li>"+d[e]+"</li>";j+="</ul>",c.messages.show(j,{"class":"error"})}c.redraw(),b&&c.perfectScale()})},Blocks.prototype.perfectScale=function(){if(!this.div)return;var a=null,b=null,c=null,d=null;for(var e in this.blocks){var f=this.blocks[e];a==null?(a=b=f.x,c=d=f.y):(a=Math.min(a,f.x-15),b=Math.max(b,f.x+f.width+18),c=Math.min(c,f.y-15),d=Math.max(d,f.y+115))}var g=this.div.width()/(b-a),h=this.div.height()/(d-c),i=Math.min(g,h);this.scale=i,this.center.x=this.div.width()/2-i*(a+b)/2,this.center.y=this.div.height()/2-i*(c+d)/2,this.redraw()},Blocks.prototype.setLabels=function(a){for(var b in this.edges){var c=this.edges[b];c.id in a&&c.setLabel(a[b])}};